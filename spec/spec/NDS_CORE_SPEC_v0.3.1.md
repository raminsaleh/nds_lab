# NDS_CORE_SPEC_v0.3.1

## 1) دامنه و تعریف
- هدف: تشخیص نودها با مشتق‌گیری از قیمت، برچسب‌گذاری توالی، ارزیابی کیفیت هوک، قواعد ابطال، و خروجی همسان برای Python/MT5.
- تایم‌فریم مرجع: M15 (قابل تنظیم).
- نودها شماره‌گذاری ترتیبی (مثلاً 1051, 1052, ...).

## 2) تشخیص نود مشتق‌محور
- محاسبهٔ مشتق (روی دادهٔ هموارشده با فیلتر ملایم) و تشخیص صفرشدن‌های معتبر P′(t).
- **Deadzone مشتق:** اگر |P′(t)| < δ ⇒ صفر تلقی شود (δ وابسته به σ محلی یا ATR).
- **Prominence/Thresholds:** پذیرش نود فقط وقتی |Δp| ≥ k_sigma·σ_local یا k_atr·ATR(m). کف ولتیلیتی: ε_floor.

## 3) توالی و قواعد ابطال
- صعودی: N1→S1→N2→S2→N3→S3
- نزولی: S1→N1→S2→N2→S3→N3
- **ابطال‌ها:**
  - **I1: Separation breach** — Δt < τ_min یا Δp < ε_min (برحسب ATR/σ).
  - **I2: Sequence violation** — نقض ترتیب مجاز.
  - **I3: Repaint guard** — نود پس از صفرشدن مشتق تا w کندل «موقت» است؛ تأیید روی بسته‌شدن کندل w.
  - **I4: Structural conflict** — پرچم `higher_than_prev` همیشه مستقل ثبت شود و با استنباط روند بازنویسی نشود.

## 4) کیفیت هوک (Hook Quality)
- **H0 (Absent):** تقارن پایدار مشاهده نمی‌شود.
- **H1 (Partial):** فقط یکی از تقارنِ قیمت/زمان در تحمل است.
- **H2 (Near-perfect):** هر دو داخل تحمل، ولی خطا > ε_hook.
- **H3 (Perfect):** هر دو داخل تحمل با خطای ≤ ε_hook.

**Tolerance:**
- نسبت قیمت: α_low ≤ ratio_price ≤ α_high
- نسبت زمان:  β_low ≤ ratio_time ≤ β_high
- مقادیر اولیهٔ قابل‌کالیبراسیون: α=[0.8,1.2]، β=[0.8,1.2]، ε_hook=0.05

## 5) خروجی‌های استاندارد (Python/MT5 parity)
`node_id, bar_index, time, price, node_type, higher_than_prev, hook_quality, seq_label?, σ_t, R̂, SL, TP, quality_score`

## 6) رفرنس‌دهی
- تمام بندهای کلیدی باید در «Evidence Map» پوشهٔ `spec/NDS_EVIDENCE_MAP_v0.1.md` به منبع (PDF/صفحه، تصویر، ویدیو/تایم‌کد) متصل شوند.
